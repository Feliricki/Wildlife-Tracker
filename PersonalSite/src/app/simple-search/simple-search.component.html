<!-- INFO: Previous this table was only loaded when both the map component and this api was fully loaded. -->
<table mat-table [dataSource]="studies" [trackBy]="trackStudy" class="study-table" *ngIf="studies">

  <!-- Name -->
  <ng-container matColumnDef="name" class="cell-container">

    <th mat-header-cell *matHeaderCellDef class="cell-header">

      <div class="search-container" *ngIf="studies">
        <form [formGroup]="searchForm">

          <div class="first-row">
            <mat-form-field class="search-form" appearance="outline">
              <mat-label>Search Studies</mat-label>

              <!-- TODO: Have this form use a submit button instead of a keyup event -->
              <input matInput type="text" #filter (keyup)="filterEvent(filter.value)" [matAutocomplete]="auto"
                class="search-input" formControlName="filterQuery" />

              <mat-autocomplete class="auto-complete" (optionSelected)="selectOption($event)" #auto="matAutocomplete">
                <!-- NOTE: currentOptions is a writable signal that contains the current options. -->
                @for (option of currentOptions(); track option){
                <mat-option [value]="option">{{option}}</mat-option>
                <mat-divider></mat-divider>
                }
              </mat-autocomplete>

              <button matSuffix mat-icon-button aria-label="Search" (click)="loadData(filter.value)">
                <mat-icon>search</mat-icon>
              </button>

            </mat-form-field>

            <span class="spacer"></span>
            <button mat-icon-button (click)="emitCloseComponentMessage()"><mat-icon>close</mat-icon></button>

          </div>

          <!-- Drop down list input -->
          <mat-form-field class="dropList">
            <mat-label>Sort Order</mat-label>
            <mat-select class="drop-selector" #mat_select value="asc" formControlName="dropDownList"
              (selectionChange)="sortData(mat_select.value)">
              <mat-option value="asc">Ascending</mat-option>
              <mat-option value="desc">Descending</mat-option>
            </mat-select>
          </mat-form-field>
        </form>
      </div>

    </th>
    <td mat-cell *matCellDef="let study; let j = index;" class="study-header-cell">
      <mat-expansion-panel #ExpansionPanel [ngStyle]="!(screenChange | async) ? largeHeaderStyle : smallHeaderStyle"
        id="expansion-panel" class="mat-elevation-z0">

        <mat-expansion-panel-header collapsedHeight="auto" expandedHeight="auto">

          <span class="header-content">
            {{study.name}}</span>

        </mat-expansion-panel-header>

        <ng-template matExpansionPanelContent class="expansion-panel-content">

          <!-- TODO: Create a custom pipe to convert to local date format -->
          <div class="expansion-content" [ngStyle]="!(screenChange | async) ? largeContentStyle : smallContentStyle">
            @if(hasLocation(study)){
            <button class="mini-button" matTooltip="Pan to study location." mat-mini-fab
              (click)="panToMarker(study.id)">
              <mat-icon aria-label="false" fontIcon="location_searching"></mat-icon>
            </button>
            } @else {
            <button class="mini-button" matTooltop="Location not available." mat-mini-fab>
              <mat-icon>location_disabled</mat-icon>
            </button>
            }

            <br>
            @if (study.timestampFirstDeployedLocation && study.timestampLastDeployedLocation){
            <span>
              <br>
              First Deployment: {{ study.timestampFirstDeployedLocation | date:"short" }} <br>
              Last Deployment: {{ study.timestampLastDeployedLocation | date:"short" }} <br><br>
            </span>
            }

            @if (study.taxonIds && (commonNames$[j] | async); as commonName){
            <span>Taxa: {{commonName}}</span><br>
            }
            @else if (study.taxonIds){
            <span>Taxa: {{study.taxonIds}}</span>
            }

            @if (study.studyObjective){
            <h4>Objective</h4>
            <p>{{study.studyObjective}}</p>
            }

            <span>Deployments: {{study.numberOfDeployments}}</span><br>
            <span>Individuals: {{study.numberOfIndividuals}}</span><br>
            <span># Of Sensors: {{study.numberOfTags}}</span><br>
            <span>Number of deployed locations: {{study.numberOfDeployedLocations}}</span><br>

            @if (study.sensorTypeIds){
            <span><br>Sensors Used: {{study.sensorTypeIds}}</span>
            }

            @if (study.acknowledgement){
            <br>
            <h4>Acknowledgements</h4>
            <p>{{study.acknowledgements}}</p>
            }

            @if (study.grantsUsed){
            <br>
            <h4>Supported by</h4>
            <p>{{study.grantsUsed}}</p>
            }

            @if (wikipediaLinks$[j] | async; as Links){
            <br>
            <h4>Links</h4>
            @for(curLink of Links; track curLink.link){
            <a [href]="curLink.link">{{curLink.link}}</a>
            }
            }
            <br>
            <div class="close-button-container">
              <button mat-icon-button (click)="ExpansionPanel.close()"
                aria-label="Close the expansion panel."><mat-icon>expand_less</mat-icon></button>
            </div>

          </div>
        </ng-template>
      </mat-expansion-panel>
    </td>
  </ng-container>


  <tr mat-header-row class="header-row" *matHeaderRowDef="displayedColumns; sticky:true"></tr>
  <tr mat-row class="study-row" *matRowDef="let row; let i = index; columns: displayedColumns;">
  </tr>
</table>

<mat-paginator class="paginator" hidden (page)="getData($event)" [pageSize]="10" [pageSizeOptions]="[10,20,50]"
  showFirstLastButtons>
</mat-paginator>
